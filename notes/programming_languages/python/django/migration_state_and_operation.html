<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <style rel="stylesheet">
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin:40px auto;
      max-width:750px;
      font-size:18px;
      padding:0 10px;
      color: #333;
    }
    pre {
      background: #f4f4f4;
      border: 1px solid #ddd;
      border-left: 3px solid #000;
      color: #777;
      page-break-inside: avoid;
      font-family: monospace;
      font-size: 15px;
      max-width: 100%;
      overflow: auto;
      padding: 1em 1.5em;
      display: block;
      word-wrap: break-word;
    }
    a {
      color: #1976d2;
      text-decoration: none;
      border-bottom: 1px solid;
    }
    img {
      max-width: 100%;
    }
    h1 {
      text-align: left;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    li {
      margin-bottom: 10px;
    }
    :not(pre) > code {
      background-color: #f4f4f4;
      padding-right: 0.2em;
      padding-left: 0.2em;
      border-radius: 3px;
    }
  </style>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p><code>last update: 2024-03-15</code></p>
<p>Sometimes it is necessary to perform changes on a Django model that cannot, or
should not, be reflected in the database.</p>
<p>A few examples of when that needs to happen:</p>
<ol>
<li>another program has changed the database, and now models need change to keep
the consistency with the database. Changing the models, should not trigger
further migrations that would duplicate (and fail) the database changes.</li>
<li>removing a previous index concurrently and updating the <code>db_index</code> property.</li>
</ol>
<p>More on the second item now.</p>
<p>When a <code>CharField</code> in Django is created with <code>db_index=True</code> Django will create
two indexes: one for exact match, and another for text index
(<code>varchar_pattern_ops</code>).</p>
<pre><code class="language-py"># Field in the model &quot;Table&quot;
field = CharField(db_index=True)
</code></pre>
<pre><code class="language-sql">// Generated migration sql as seen from `sqlmigrate`
CREATE INDEX &quot;app_table_field_9878d9_idx&quot; ON &quot;app_table&quot; (&quot;field&quot;);
CREATE INDEX &quot;app_table_field_9878d9_idx_like&quot; ON &quot;app_table&quot; (&quot;field&quot;, varchar_pattern_ops);
</code></pre>
<p>The second index is almost always <strong>not</strong> what you want. Specially if the
CharField is a choice field. But also, this kind of index only works for
prefixed anchored search (<code>LIKE 'pre%'</code>), it does not work for postfixed
anchored search (<code>LIKE '%post'</code>) as it will do a table scan.</p>
<p>If your changes are already in production, you now have to create a new
migration that has state changes and operations split up. You can do so by
using <code>SeparateDatabaseAndState</code>.</p>
<p>From the docs:</p>
<blockquote>
<p>A highly specialized operation that lets you mix and match the database
(schema-changing) and state (autodetector-powering) aspects of operations.</p>
</blockquote>
<blockquote>
<p>It accepts two lists of operations. When asked to apply state, it will use
the <code>state_operations</code> list (this is a generalized version of RunSQLâ€™s
<code>state_operations</code> argument). When asked to apply changes to the database, it
will use the <code>database_operations</code> list.</p>
</blockquote>
<p>To create a migration that removes that index, for example, start with an empty
canvas:</p>
<pre><code class="language-sh">./manage.py makemigrations --empty myapp --name remove_my_sweet_index
</code></pre>
<p>You will get this:</p>
<pre><code class="language-py"># Generated by Django 4.1.12 on 2024-03-12 21:35

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('myapp', '0005_myapp_previous_migration'),
    ]

    operations = [
    ]
</code></pre>
<p>Make sure the migration is not atomic, and that the index is removed
concurrently:</p>
<pre><code class="language-diff">  class Migration(migrations.Migration):
+     atomic = False

      dependencies = [
          (&quot;events&quot;, &quot;0005_externalevent_account_user_id&quot;),
      ]

      operations = [
+        migrations.SeparateDatabaseAndState(
+            database_operations=[
+                # This index is being removed because it is not being used by the
+                # application.
+                migrations.operations.RunSQL(
+                    sql=&quot;DROP INDEX CONCURRENTLY IF EXISTS app_table_field_9878d9_idx_like;&quot;,
+                    reverse_sql=migrations.operations.RunSQL.noop,
+                ),
+            ],
+            state_operations=[
+                # This is only here so that we can remove the `db_index=True` from the
+                # Django model without resorting to extra migrations.
+                migrations.AlterField(
+                    model_name=&quot;table&quot;,
+                    name=&quot;field&quot;,
+                    # note that db_index=True was removed.
+                    field=models.CharField(max_length=256),
+                ),
+                # This was added from adding the index to the Meta class.
+                migrations.AddIndex(
+                    model_name=&quot;table&quot;,
+                    index=models.Index(
+                        fields=[&quot;field&quot;], name=&quot;app_table_field_9878d9_idx&quot;
+                    ),
+                ),
+            ],
+        )
      ]
</code></pre>
<p>And also make sure to update the models:</p>
<pre><code class="language-python">    field = CharField()

    class Meta:
        # Now that the db_index=False, we just put the exact-match index
        # in here.
        models.Index(fields=[&quot;field&quot;], name=&quot;app_table_field_9878d9_idx&quot;),
</code></pre>
<script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
</body>
</html>
