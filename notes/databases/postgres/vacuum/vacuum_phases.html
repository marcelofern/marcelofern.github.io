<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <style rel="stylesheet">
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin:40px auto;
      max-width:750px;
      font-size:18px;
      padding:0 10px;
      color: #333;
    }
    pre {
      background: #f4f4f4;
      border: 1px solid #ddd;
      border-left: 3px solid #000;
      color: #777;
      page-break-inside: avoid;
      font-family: monospace;
      font-size: 15px;
      max-width: 100%;
      overflow: auto;
      padding: 1em 1.5em;
      display: block;
      word-wrap: break-word;
    }
    a {
      color: #1976d2;
      text-decoration: none;
      border-bottom: 1px solid;
    }
    img {
      max-width: 100%;
    }
    h1 {
      text-align: left;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    li {
      margin-bottom: 10px;
    }
    :not(pre) > code {
      background-color: #f4f4f4;
      padding-right: 0.2em;
      padding-left: 0.2em;
      border-radius: 3px;
    }
  </style>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1>VACUUM Phases</h1>
<pre><code class="language-">Created at: 2025-01-08
</code></pre><ol><li><b>INITIALIZING</b>: VACUUM is preparing to begin scanning the heap. This phase is expected to be very brief.</li></ol>
<p>2. <b>SCANNING HEAP</b>: VACUUM is currently scanning the heap. It will prune and defragment each page if required, and possibly perform freezing activity. The heap_blks_scanned column can be used to monitor the progress of the scan.</p>
<p>3. <b>VACUUMING INDEXES</b>: VACUUM is currently vacuuming the indexes. If a table has any indexes, this will happen at least once per vacuum, after the heap has been completely scanned. It may happen multiple times per vacuum if maintenance_work_mem (or, in the case of autovacuum, autovacuum_work_mem if set) is insufficient to store the number of dead tuples found.</p>
<p>4. <b>VACUUMING HEAP</b>: VACUUM is currently vacuuming the heap. Vacuuming the heap is distinct from scanning the heap, and occurs after each instance of vacuuming indexes. If heap_blks_scanned is less than heap_blks_total (see notes below), the system will return to scanning the heap after this phase is completed; otherwise, it will begin cleaning up indexes after this phase is completed.</p>
<p>5. <b>CLEANING UP INDEXES</b>: VACUUM is currently cleaning up indexes. This occurs after the heap has been completely scanned and all vacuuming of the indexes and the heap has been completed.</p>
<p>6. <b>TRUNCATING HEAP</b>: VACUUM is currently truncating the heap so as to return empty pages at the end of the relation to the operating system. This occurs after cleaning up indexes.</p>
<p>7. <b>PERFORMING FINAL CLEANUP</b>: VACUUM is performing final cleanup. During this phase, VACUUM will vacuum the free space map, update statistics in pg_class, and report statistics to the cumulative statistics system. When this phase is completed, VACUUM will end.</p>
<p>Notes:</p>
<ul><li>heap_blks_total: Total number of heap blocks in the table. This number is reported as of the beginning of the scan; blocks added later will not be (and need not be) visited by this VACUUM.</li></ul>
<p><a href="https://www.postgresql.org/docs/current/progress-reporting.html#VACUUM-PHASES">source</a></p>
<h2>Progress Reporting</h2>
<blockquote>Whenever VACUUM is running, the pg_stat_progress_vacuum view will contain one</blockquote>
<blockquote>row for each backend (including autovacuum worker processes) that is</blockquote>
<blockquote>currently vacuuming. The tables below describe the information that will be</blockquote>
<blockquote>reported and provide information about how to interpret it. Progress for</blockquote>
<blockquote>VACUUM FULL commands is reported via pg_stat_progress_cluster because both</blockquote>
<blockquote>VACUUM FULL and CLUSTER rewrite the table, while regular VACUUM only modifies</blockquote>
<blockquote>it in place.</blockquote>
<p><code>pg_stat_progress_vacuum</code> View</p>
<p>pid integer: <blockquote>PPrroocceessss  IIDD  ooff  bbaacckkeenndd..</p>
</blockquote>
<p>datid oid: <blockquote>OOIIDD  ooff  tthhee  ddaattaabbaassee  ttoo  wwhhiicchh  tthhiiss  bbaacckkeenndd  iiss  ccoonnnneecctteedd..</p>
</blockquote>
<p>datname name: <blockquote>NNaammee  ooff  tthhee  ddaattaabbaassee  ttoo  wwhhiicchh  tthhiiss  bbaacckkeenndd  iiss  ccoonnnneecctteedd..</p>
</blockquote>
<p>relid oid: <blockquote>OOIIDD  ooff  tthhee  ttaabbllee  bbeeiinngg  vvaaccuuuummeedd..</p>
</blockquote>
<p>phase text: <blockquote>CCuurrrreenntt  pprroocceessssiinngg  pphhaassee  ooff  vvaaccuuuumm..  SSeeee  TTaabbllee  2277..4466..</p>
</blockquote>
<p>heap_blks_total bigint <blockquote>TToottaall  nnuummbbeerr  ooff  hheeaapp  bblloocckkss  iinn  tthhee  ttaabbllee..  TThhiiss  nnuummbbeerr  iiss  rreeppoorrtteedd  aass  ooff  tthhee</blockquote>
<blockquote>bbeeggiinnnniinngg  ooff  tthhee  ssccaann;;  bblloocckkss  aaddddeedd  llaatteerr  wwiillll  nnoott  bbee  ((aanndd  nneeeedd  nnoott  bbee))</blockquote>
<blockquote>vviissiitteedd  bbyy  tthhiiss  VVAACCUUUUMM..</p>
</blockquote>
<p>heap_blks_scanned bigint: <blockquote>NNuummbbeerr  ooff  hheeaapp  bblloocckkss  ssccaannnneedd..  BBeeccaauussee  tthhee  vviissiibbiilliittyy  mmaapp  iiss  uusseedd  ttoo  ooppttiimmiizzee</blockquote>
<blockquote>ssccaannss,,  ssoommee  bblloocckkss  wwiillll  bbee  sskkiippppeedd  wwiitthhoouutt  iinnssppeeccttiioonn;;  sskkiippppeedd  bblloocckkss  aarree</blockquote>
<blockquote>iinncclluuddeedd  iinn  tthhiiss  ttoottaall,,  ssoo  tthhaatt  tthhiiss  nnuummbbeerr  wwiillll  eevveennttuuaallllyy  bbeeccoommee  eeqquuaall  ttoo</blockquote>
<blockquote>hheeaapp__bbllkkss__ttoottaall  wwhheenn  tthhee  vvaaccuuuumm  iiss  ccoommpplleettee..  TThhiiss  ccoouunntteerr  oonnllyy  aaddvvaanncceess  wwhheenn</blockquote>
<blockquote>tthhee  pphhaassee  iiss  ssccaannnniinngg  hheeaapp..</p>
</blockquote>
<p>heap_blks_vacuumed bigint: <blockquote>NNuummbbeerr  ooff  hheeaapp  bblloocckkss  vvaaccuuuummeedd..  UUnnlleessss  tthhee  ttaabbllee  hhaass  nnoo  iinnddeexxeess,,  tthhiiss  ccoouunntteerr</blockquote>
<blockquote>oonnllyy  aaddvvaanncceess  wwhheenn  tthhee  pphhaassee  iiss  vvaaccuuuummiinngg  hheeaapp..  BBlloocckkss  tthhaatt  ccoonnttaaiinn  nnoo  ddeeaadd</blockquote>
<blockquote>ttuupplleess  aarree  sskkiippppeedd,,  ssoo  tthhee  ccoouunntteerr  mmaayy  ssoommeettiimmeess  sskkiipp  ffoorrwwaarrdd  iinn  llaarrggee</blockquote>
<blockquote>iinnccrreemmeennttss..</p>
</blockquote>
<p>index_vacuum_count bigint: <blockquote>NNuummbbeerr  ooff  ccoommpplleetteedd  iinnddeexx  vvaaccuuuumm  ccyycclleess..</p>
</blockquote>
<p>max_dead_tuple_bytes bigint: <blockquote>AAmmoouunntt  ooff  ddeeaadd  ttuuppllee  ddaattaa  tthhaatt  wwee  ccaann  ssttoorree  bbeeffoorree  nneeeeddiinngg  ttoo  ppeerrffoorrmm  aann</blockquote>
<blockquote>iinnddeexx  vvaaccuuuumm  ccyyccllee,,  bbaasseedd  oonn  mmaaiinntteennaannccee__wwoorrkk__mmeemm..</p>
</blockquote>
<p>dead_tuple_bytes bigint: <blockquote>AAmmoouunntt  ooff  ddeeaadd  ttuuppllee  ddaattaa  ccoolllleecctteedd  ssiinnccee  tthhee  llaasstt  iinnddeexx  vvaaccuuuumm  ccyyccllee..</p>
</blockquote>
<p>num_dead_item_ids bigint: <blockquote>NNuummbbeerr  ooff  ddeeaadd  iitteemm  iiddeennttiiffiieerrss  ccoolllleecctteedd  ssiinnccee  tthhee  llaasstt  iinnddeexx  vvaaccuuuumm  ccyyccllee..</p>
</blockquote>
<p>indexes_total bigint: <blockquote>TToottaall  nnuummbbeerr  ooff  iinnddeexxeess  tthhaatt  wwiillll  bbee  vvaaccuuuummeedd  oorr  cclleeaanneedd  uupp..  TThhiiss  nnuummbbeerr  iiss</blockquote>
<blockquote>rreeppoorrtteedd  aatt  tthhee  bbeeggiinnnniinngg  ooff  tthhee  vvaaccuuuummiinngg  iinnddeexxeess  pphhaassee  oorr  tthhee  cclleeaanniinngg  uupp</blockquote>
<blockquote>iinnddeexxeess  pphhaassee..</p>
</blockquote>
<p>indexes_processed bigint: <blockquote>NNuummbbeerr  ooff  iinnddeexxeess  pprroocceesssseedd..  TThhiiss  ccoouunntteerr  oonnllyy  aaddvvaanncceess  wwhheenn  tthhee  pphhaassee  iiss</blockquote>
<blockquote>vvaaccuuuummiinngg  iinnddeexxeess  oorr  cclleeaanniinngg  uupp  iinnddeexxeess..</p>
</blockquote>
<h2>Useful Queries</h2>
<pre><code class="language-sql">SELECT
  p.pid,
  now() - a.xact_start AS duration,
  coalesce(wait_event_type ||'.'|| wait_event, 'f') AS waiting,
  CASE
    WHEN a.query ~*'^autovacuum.*to prevent wraparound' THEN 'wraparound'
    WHEN a.query ~*'^vacuum' THEN 'user'
  ELSE
    'regular'
  END AS mode,
  p.datname AS database,
  p.relid::regclass AS table,
  p.phase,
  pg_size_pretty(p.heap_blks_total * current_setting('block_size')::int) AS table_size,
  pg_size_pretty(pg_total_relation_size(relid)) AS total_size,
  pg_size_pretty(p.heap_blks_scanned * current_setting('block_size')::int) AS scanned,
  pg_size_pretty(p.heap_blks_vacuumed * current_setting('block_size')::int) AS vacuumed,
  round(100.0 * p.heap_blks_scanned / p.heap_blks_total, 1) AS scanned_pct,
  round(100.0 * p.heap_blks_vacuumed / p.heap_blks_total, 1) AS vacuumed_pct,
  p.index_vacuum_count,
  round(100.0 * p.num_dead_tuples / p.max_dead_tuples,1) AS dead_pct
FROM pg_stat_progress_vacuum p
JOIN pg_stat_activity a using (pid)
ORDER BY now() - a.xact_start DESC;
</code></pre><p>Or simpler:</p>
<pre><code class="language-sql">SELECT * FROM pg_stat_progress_vacuum
WHERE oid = 'my_sweet_table'::regclass;
</code></pre><script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
</body>
</html>
