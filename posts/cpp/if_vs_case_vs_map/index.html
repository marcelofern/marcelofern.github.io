<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-176835131-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-176835131-1');
  </script>

  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Marcelo Fernandes" />
  <meta name="dcterms.date" content="2023-03-06" />
  <title>if vs case vs map</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
<style rel="stylesheet">
  html {
    font-size: 16px;
  }
  body {
    hyphens: auto;
    text-align: justify;
    line-height: 1.7;
  }
  a {
    color: #1976d2;
    text-decoration: none;
    border-bottom: 1px solid;
  }
  a:visited {
    color: #1976d2;
  }
  pre.sourceCode {
    border-left: 3px solid #000;
    padding-left: 1.5rem;
    margin: 1em 0;
  }
  figcaption {
    display: none;
  }
</style>
<link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">if vs case vs map</h1>
<p class="author">Marcelo Fernandes</p>
<p class="date">March 06, 2023</p>
</header>
<h2 id="the-introduction">The introduction</h2>
<p>There’re a lot of misconceptions about how <code>if</code> and
<code>case</code> statements are compiled, and how they perform. Often
as those statements grow large (20+ lines) code-reviewers will say “can
you refactor these if/else or case chains into a mapper so that the code
is more clean?”</p>
<p>So the idea here is to check whether or not the code is cleaner, and
how much we pay in performance in order to get it.</p>
<h2 id="the-example">The example</h2>
<p>Let’s start with a simple example. Say you’re developing a game of
chess and you need to return a char representation of the chess piece at
hand. Easy.</p>
<p>Your enum of pieces is something like this:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Pieces <span class="op">{</span>PAWN<span class="op">,</span> KNIGHT<span class="op">,</span> BISHOP<span class="op">,</span> ROOK<span class="op">,</span> QUEEN<span class="op">,</span> KING<span class="op">};</span></span></code></pre></div>
<p>Let’s start with an approach using if statements:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> if_func<span class="op">(</span>PieceType piece<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>piece <span class="op">==</span> PAWN<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="ch">&#39;p&#39;</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>piece <span class="op">==</span> KNIGHT<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="ch">&#39;k&#39;</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>piece <span class="op">==</span> BISHOP<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="ch">&#39;b&#39;</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>piece <span class="op">==</span> ROOK<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="ch">&#39;r&#39;</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>piece <span class="op">==</span> QUEEN<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="ch">&#39;q&#39;</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="ch">&#39;k&#39;</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>And here is another example using case statements.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> case_func<span class="op">(</span>PieceType piece<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span><span class="op">(</span>piece<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> PAWN<span class="op">:</span> <span class="cf">return</span> <span class="ch">&#39;p&#39;</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> KNIGHT<span class="op">:</span> <span class="cf">return</span> <span class="ch">&#39;k&#39;</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> BISHOP<span class="op">:</span> <span class="cf">return</span> <span class="ch">&#39;b&#39;</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> ROOK<span class="op">:</span> <span class="cf">return</span> <span class="ch">&#39;r&#39;</span><span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> QUEEN<span class="op">:</span> <span class="cf">return</span> <span class="ch">&#39;q&#39;</span><span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span> <span class="cf">return</span> <span class="ch">&#39;k&#39;</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Before going any further, let’s compare the assembly code generated
from these functions.</p>
<h2 id="assembly-code">Assembly code</h2>
<p>Firstly, let’s start with the assembly code for the <code>if</code>
statement version:</p>
<figure>
<img src="if_assembly.png" alt="if_assembly" />
<figcaption aria-hidden="true">if_assembly</figcaption>
</figure>
<p>Very straightforward. Store the input value in a register, compare
with the integers corresponding to the enum (0, 1, 2, 3, 4, 5) and spits
out the equivalent char (as an int).</p>
<p>How does this compare to the <code>case</code> statement?</p>
<figure>
<img src="case_assembly.png" alt="case_assembly" />
<figcaption aria-hidden="true">case_assembly</figcaption>
</figure>
<p>The <code>case</code> statement seems more complicated as it needs to
use a lookup table, but this is expected.</p>
<h2 id="benchmarking">Benchmarking</h2>
<p>Before proceeding to the “clean” code approach, let’s run some
benchmarking to see how the if statement compares to the switch one.</p>
<p>Our test bench will look like this:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;catch2/catch.hpp&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span>PieceType<span class="op">&gt;</span> pieces <span class="op">=</span> <span class="op">{</span>PAWN<span class="op">,</span> KNIGHT<span class="op">,</span> BISHOP<span class="op">,</span> ROOK<span class="op">,</span> QUEEN<span class="op">,</span> KING<span class="op">};</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> test_if<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">1000000</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span> <span class="op">&amp;</span>piece <span class="op">:</span> pieces<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      if_func<span class="op">(</span>piece<span class="op">);</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> test_case<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">1000000</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span> <span class="op">&amp;</span>piece <span class="op">:</span> pieces<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>      case_func<span class="op">(</span>piece<span class="op">);</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>TEST_CASE<span class="op">(</span><span class="st">&quot;IF vs CASE&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  BENCHMARK<span class="op">(</span><span class="st">&quot;test case&quot;</span><span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> test_case<span class="op">();</span> <span class="op">};</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  BENCHMARK<span class="op">(</span><span class="st">&quot;test if&quot;</span><span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> test_if<span class="op">();</span> <span class="op">};</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We will run through the vector one million times, and see how this
compares.</p>
<figure>
<img src="case_vs_if.png" alt="case_vs_if" />
<figcaption aria-hidden="true">case_vs_if</figcaption>
</figure>
<p>This is an unfortunate scenario for our <code>case</code> statement.
Lookup tables get better as the number of different <code>case</code>s
raises. But in this case, we only have a few cases and their occurrence
is evenly distributed due to the way the benchmark code was set. That’s
why our <code>if</code> statement with many <code>cmp</code>s and
<code>jmp</code>s in assembly managed to perform better.</p>
<p>In other words, the worst case scenario for our if statement (when it
receives a ‘king’ and it needs to jump all the way down the assembly
code) only happens 1 out of 6 times. Whereas the <code>case</code>
function needs to always use the lookup table no matter what.</p>
<p>I used this example on purpose, because generally speaking developers
say that <code>case</code> statements are faster than <code>if</code>
statements. While this is true for many scenarios, this isn’t
<strong>always</strong> true.</p>
<p>If we had cherry picked our vector of pieces to only contain kings,
the result would be different. Consider substituting this line:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// std::vector&lt;PieceType&gt; pieces = {PAWN, KNIGHT, BISHOP, ROOK, QUEEN, KING};</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span>PieceType<span class="op">&gt;</span> pieces <span class="op">=</span> <span class="op">{</span>KING<span class="op">,</span> KING<span class="op">,</span> KING<span class="op">,</span> KING<span class="op">,</span> KING<span class="op">,</span> KING<span class="op">};</span></span></code></pre></div>
<p>The results are quite different as we’ve reached the worst case
scenario more times.</p>
<figure>
<img src="case_vs_if_2.png" alt="case_vs_if_2" />
<figcaption aria-hidden="true">case_vs_if_2</figcaption>
</figure>
<p>Now we finally reached equivalence by unbalancing our sampling data.
In real life it will be difficult to tell how the distribution of our
samples will look like, so why don’t we run this example with a Gaussian
distribution?</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// std::vector&lt;PieceType&gt; pieces = {KING, KING, KING, KING, KING, KING};</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span>PieceType<span class="op">&gt;</span> pieces <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  PAWN<span class="op">,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  KNIGHT<span class="op">,</span> KNIGHT<span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  BISHOP<span class="op">,</span> BISHOP<span class="op">,</span> BISHOP<span class="op">,</span> BISHOP<span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  ROOK<span class="op">,</span> ROOK<span class="op">,</span> ROOK<span class="op">,</span> ROOK<span class="op">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  QUEEN<span class="op">,</span> QUEEN<span class="op">,</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  KING<span class="op">,</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>That looks fair! Let’s see the results:</p>
<figure>
<img src="case_vs_if_3.png" alt="case_vs_if_3" />
<figcaption aria-hidden="true">case_vs_if_3</figcaption>
</figure>
<p>With 6 different variables to switch from, our <code>if</code>
statement is comparable to a <code>case</code> statement. For anything
less than that, it will usually be faster, and for anything more than
that, it will usually be slower.</p>
<p>I’m being really picky here, in real-life situations this difference
might not mean anything. But the reason why I’m comparing both will
become clear next.</p>
<h2 id="the-clean-code-alternative">The clean code alternative</h2>
<p>I haven’t worked with C++ in a while, so let’s have a brief pause
here to talk about something that happens in my daily Python</p>
<p>A code reviewer will look at our <code>if</code> or <code>case</code>
function and will block the Pull Request saying:</p>
<blockquote>
<p>Mmmm, this doesn’t look super clean. Can we move it to a mapper
instead?</p>
</blockquote>
<p>So you end up with something like this:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>unordered_map<span class="op">&lt;</span>PieceType<span class="op">,</span> <span class="dt">char</span><span class="op">&gt;</span> mapper <span class="op">=</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>PAWN<span class="op">,</span> <span class="ch">&#39;p&#39;</span><span class="op">},</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KNIGHT<span class="op">,</span> <span class="ch">&#39;k&#39;</span><span class="op">},</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>BISHOP<span class="op">,</span> <span class="ch">&#39;b&#39;</span><span class="op">},</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>ROOK<span class="op">,</span> <span class="ch">&#39;r&#39;</span><span class="op">},</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>QUEEN<span class="op">,</span> <span class="ch">&#39;q&#39;</span><span class="op">},</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span>KING<span class="op">,</span> <span class="ch">&#39;k&#39;</span><span class="op">},</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> mapper_func<span class="op">(</span>PieceType piece<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mapper<span class="op">[</span>piece<span class="op">];</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So much cleaner, right?! Well, arguably. But the central question is:
why use a full on hash table just for looking up 6 different values?
Isn’t this too overkill? Does the clean code excuse really matters here?
Is the alternative if or case statement even “dirty”?</p>
<p>Let’s see how this performs. We’ll add another benchmarking using
this new mapper function and rerun the code.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> test_mapper<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">1000000</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span> <span class="op">&amp;</span>piece <span class="op">:</span> pieces<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>      mapper_func<span class="op">(</span>piece<span class="op">);</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  BENCHMARK<span class="op">(</span><span class="st">&quot;test mapper&quot;</span><span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> test_mapper<span class="op">();</span> <span class="op">};</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span></code></pre></div>
<figure>
<img src="case_vs_if_vs_mapper.png" alt="case_vs_if_vs_mapper" />
<figcaption aria-hidden="true">case_vs_if_vs_mapper</figcaption>
</figure>
<p>This is too slow! We are running almost 10x slower now on our “clean”
code approach. This is obvious, we don’t need a hash table here, we’re
just switching returns based on a enum of 6 different types.</p>
<h2 id="conclusion">Conclusion</h2>
<ul>
<li>Beware of “clean code” conventions without reason. If some of they
propagate throughout your code base you end up with much slower
code.</li>
<li>If you have too many conditionals (say more than 6) prefer using
<code>switch</code>/<code>case</code> statements, otherwise
<code>if</code> is fine.</li>
</ul>
</body>
</html>
