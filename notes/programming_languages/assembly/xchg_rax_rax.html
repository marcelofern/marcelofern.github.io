<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Marcelo Fernandes" />
  <title>xchg rax, rax</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
<style rel="stylesheet">
  html {
    font-size: 16px;
  }
  body {
    hyphens: auto;
    text-align: justify;
    line-height: 1.7;
  }
  a {
    color: #1976d2;
    text-decoration: none;
    border-bottom: 1px solid;
  }
  a:visited {
    color: #1976d2;
  }
  pre.sourceCode {
    border-left: 3px solid #000;
    padding-left: 1.5rem;
    margin: 1em 0;
  }
  figcaption {
    display: none;
  }
</style>
<link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">xchg rax, rax</h1>
<p class="author">Marcelo Fernandes</p>
<p class="date">February 18th, 2024</p>
</header>
<h1 id="introduction">Introduction</h1>
<p>These are the solutions for the problems in the book
<code>xchg rax, rax</code>.</p>
<h2 id="x00">0x00</h2>
<p>This code represents different ways of zeroâ€™ing registers:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">xor</span> <span class="kw">eax</span><span class="op">,</span> <span class="kw">eax</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">lea</span> <span class="kw">rbx</span><span class="op">,</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">loop</span> <span class="op">$</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="bu">mov</span> <span class="kw">rdx</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">and</span> <span class="kw">esi</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="bu">sub</span> <span class="kw">edi</span><span class="op">,</span> <span class="kw">edi</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="bu">push</span> <span class="dv">0</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="bu">pop</span> <span class="kw">rbp</span></span></code></pre></div>
<p>The interesting trick here is:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">loop</span> <span class="op">$</span></span></code></pre></div>
<p>The above creates an infinite loop until RCX reaches zero. The mark
<code>$</code> corresponds to the current location or address in the
code. This means that <code>loop</code> will loop back to itself.</p>
<h2 id="x01">0x01</h2>
<p>rax and rdx are summed, where rax stores the value of the summation,
and rdx stores the old value of rax before the summation.</p>
<p>It can also compute the rcxâ€™d element of the fibonnaci sequence
assuming that rax = 0 and rdx = 1.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.loop:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">xadd</span> <span class="kw">rax</span><span class="op">,</span> <span class="kw">rdx</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">loop</span> <span class="op">.</span>loop</span></code></pre></div>
<p>Note that <code>xadd</code> (Exchange and add) means:</p>
<blockquote>
<p>Exchanges the first operand (destination operand) with the second
operand (source operand), then loads the sum of the two values into the
destination operand. The destination operand can be a register or a
memory location; the source operand is a register.</p>
</blockquote>
<h2 id="x02">0x02</h2>
<p>Returns 0 if rax is 0, returns 1 otherwise. Perhaps a boolean check.
The resulting value is stored in rax itself.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">neg</span> <span class="kw">rax</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">sbb</span> <span class="kw">rax</span><span class="op">,</span> <span class="kw">rax</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">neg</span> <span class="kw">rax</span></span></code></pre></div>
<p>Note that <code>sbb</code> (Subtraction with borrow) means:</p>
<blockquote>
<p>Adds the source operand (second operand) and the carry (CF) flag, and
subtracts the result from the destination operand (first operand). The
result of the subtraction is stored in the destination operand. The
destination operand can be a register or a memory location; the source
operand can be an immediate, a register, or a memory location.</p>
</blockquote>
<p>And <code>neg</code> is a twoâ€™s complement negation.</p>
<h2 id="x03">0x03</h2>
<p>This returns the least of two numbers (rax or rdx):</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sub</span> <span class="kw">rdx</span><span class="op">,</span> <span class="kw">rax</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">sbb</span> <span class="kw">rcx</span><span class="op">,</span> <span class="kw">rcx</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">and</span> <span class="kw">rcx</span><span class="op">,</span> <span class="kw">rdx</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">add</span> <span class="kw">rax</span><span class="op">,</span> <span class="kw">rcx</span></span></code></pre></div>
<p>In other words:</p>
<pre><code>if rdx &gt; rax:
  return rax
else:
  return rdx</code></pre>
<p>Note that <code>sbb</code> (Subtraction with borrow) means:</p>
<blockquote>
<p>Adds the source operand (second operand) and the carry (CF) flag, and
subtracts the result from the destination operand (first operand). The
result of the subtraction is stored in the destination operand. The
destination operand can be a register or a memory location; the source
operand can be an immediate, a register, or a memory location.</p>
</blockquote>
<h2 id="x04">0x04</h2>
<p>Toggles the case of a char (upper/lower)</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">xor</span> <span class="kw">al</span><span class="op">,</span> <span class="bn">0x20</span></span></code></pre></div>
<h2 id="x05">0x05</h2>
<p>I had to look this one up online:</p>
<blockquote>
<p>Allows to branch depending on whether rax is in range [5,9] using
only one jbe jump.</p>
</blockquote>
<div class="sourceCode" id="cb8"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sub</span> <span class="kw">rax</span><span class="op">,</span> <span class="dv">5</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cmp</span> <span class="kw">rax</span><span class="op">,</span> <span class="dv">4</span></span></code></pre></div>
<h2 id="x06">0x06</h2>
<p>This does nothing.</p>
<p>The <code>NOT</code> instruction is a logical negation. If you have
1010, it becomes 0101. The <code>NEG</code> instruction is the twoâ€™s
complement negative.</p>
<p>The twoâ€™s compliment algorithm is basically:</p>
<ul>
<li>Step 1: starting with the binary representation of the number, with
the leading bit being a sign bit;</li>
<li>Step 2: inverting (or flipping) all bits â€“ changing every 0 to 1,
and every 1 to 0;</li>
<li>Step 3: adding 1 to the entire inverted number, ignoring any
overflow. Accounting for overflow will produce the wrong value for the
result.</li>
</ul>
<p>So negating and adding one, is the same thing as <code>NEG</code>. So
weâ€™re basically executing <code>NEG</code> twice, which give us the same
result.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">not</span> <span class="kw">rax</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">inc</span> <span class="kw">rax</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">neg</span> <span class="kw">rax</span></span></code></pre></div>
<h2 id="x07">0x07</h2>
<p>This also does nothing.</p>
<p>Say rax is 10.</p>
<ol type="1">
<li>inc rax == 11</li>
<li>neg rax == -11</li>
<li>inc rax == -10</li>
<li>neg rax == 10</li>
</ol>
<div class="sourceCode" id="cb10"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">inc</span> <span class="kw">rax</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">neg</span> <span class="kw">rax</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="bu">inc</span> <span class="kw">rax</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="bu">neg</span> <span class="kw">rax</span></span></code></pre></div>
<h2 id="x08">0x08</h2>
<p><code>rcr</code> is like a shift to the right, which is effectively a
division by two.</p>
<p>The below calculates the average between rax and rdx.</p>
<p>However, if thereâ€™s some overflow, or for example if one operator is
negative and the other positive, the operation can fail.</p>
<p>Try setting rax to -20 and rdx to 30, for example.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">add</span> <span class="kw">rax</span><span class="op">,</span> <span class="kw">rdx</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">rcr</span> <span class="kw">rax</span><span class="op">,</span> <span class="dv">1</span></span></code></pre></div>
<h2 id="x09">0x09</h2>
<p>Calculates rax/8 and rounds it up to the near integer.</p>
<p>Try with: - rax = 9 - rax = 7 - rax = 8 - rax = 15</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">shr</span> <span class="kw">rax</span><span class="op">,</span> <span class="dv">3</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">adc</span> <span class="kw">rax</span><span class="op">,</span> <span class="dv">0</span></span></code></pre></div>
<h2 id="x0a">0x0a</h2>
<blockquote>
<p>Increments by one an arbitrarily long little-endian integer at
rdi.</p>
</blockquote>
<p>I had to look this one up.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">add</span> <span class="dt">byte</span> <span class="op">[</span><span class="kw">rdi</span><span class="op">],</span> <span class="dv">1</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.loop:</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">inc</span> <span class="kw">rdi</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">adc</span> <span class="dt">byte</span> <span class="op">[</span><span class="kw">rdi</span><span class="op">],</span> <span class="dv">0</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">loop</span> <span class="op">.</span>loop</span></code></pre></div>
<h2 id="x0b">0x0b</h2>
<p>My solution was: Negate <code>rdx</code> if <code>rax</code> == 0, do
a <code>not</code> otherwise.</p>
<blockquote>
<p>Computes the negation of the 128-bit integer stored in the RDX:RAX
registers (thanks Aviya Erenfeld!).</p>
</blockquote>
<div class="sourceCode" id="cb14"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">not</span> <span class="kw">rdx</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">neg</span> <span class="kw">rax</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">sbb</span> <span class="kw">rdx</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span></span></code></pre></div>
</body>
</html>
